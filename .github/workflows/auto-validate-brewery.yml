name: Auto-Validate Brewery Submission

on:
  issues:
    types: [opened, edited]

jobs:
  validate-with-claude:
    if: contains(github.event.issue.labels.*.name, 'brewery-addition') || contains(github.event.issue.labels.*.name, 'brewery-update') || contains(github.event.issue.labels.*.name, 'brewery-closed')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_permissions: "Bash(*:*)"
          claude_args: "--model claude-3-5-haiku-20241022"
          prompt: |
            Review this brewery submission for data quality and completeness.

            Issue: #${{ github.event.issue.number }}
            Title: ${{ github.event.issue.title }}

            Issue Body:
            ${{ github.event.issue.body }}

            The issue body above contains all the brewery information submitted by the user.

            Please validate:
            1. All required fields are present and properly formatted
            2. Brewery name is valid and not duplicate (check breweries.json)
            3. Address is complete with city, state, country
            4. Phone number format is valid (if provided)
            5. Website URL is valid (if provided)
            6. Brewery type is one of: micro, nano, regional, brewpub, large, planning, bar, contract, proprietor, closed

            If valid:
            - Add a comment with ✅ and message: "**Validation Passed!** This brewery submission has been validated and is ready for approval. All required fields are present and properly formatted. A course instructor will review and approve this submission shortly."
            - Add the label "validated" to the issue

            If invalid:
            - Add a comment with ❌ explaining what's missing or incorrect
            - Add the label "needs-revision" to the issue
